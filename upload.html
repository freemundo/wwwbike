<!DOCTYPE html>
<html>
<head>
  <title>User Registration</title>
</head>
<body>
  <form id="userForm" enctype="multipart/form-data">
    <input type="text" name="firstName" placeholder="First Name" required><br>
    <input type="text" name="surname" placeholder="Surname" required><br>
    <input type="email" name="emailAddress" placeholder="Email Address" required><br>
    <input type="file" id="photoUpload" accept="image/*" required><br>
    <button type="submit">Submit</button>
  </form>

  <script>
    const form = document.getElementById('userForm');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const fileInput = document.getElementById('photoUpload');
      const file = fileInput.files[0];
      const blobName = Date.now() + "-" + file.name;

      // Replace with your actual SAS URL scoped to the 'photos' container
      const sasToken = "?sp=racwl&st=2025-09-30T16:17:57Z&se=2025-10-01T00:32:57Z&spr=https&sv=2024-11-04&sr=c&sig=pd3QH%2BhVkeKuaoBF80cey30DfVpDWGI82ZcvrbDEr2U%3D";
      const sasUrl = "https://namestore123.blob.core.windows.net/photos/" + blobName + sasToken;
      try {
        // Upload photo to Blob Storage
        await fetch(sasUrl, {
          method: "PUT",
          headers: {
            "x-ms-blob-type": "BlockBlob",
            "Content-Type": file.type
          },
          body: file
        });

        // Prepare metadata for Table Storage
        const metadata = {
          partition: "users",
          firstName: form.firstName.value,
          surname: form.surname.value,
          emailAddress: form.emailAddress.value,
          photoUrl: sasUrl.split("?")[0] // Strip SAS for storage
        };

        // Submit metadata to Azure Function
        const response = await fetch("https://tablewriter.azurewebsites.net/api/WriteToTable?code=ZOKyM9uD7jYoGyw0I-hmh40XCN59osU4xn5U6qwq0BK6AzFu1WDIlw==", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(metadata)
        });

        const result = await response.text();
        alert("Photo uploaded and metadata saved:\n" + result);
      } catch (err) {
        console.error("Upload failed:", err);
        alert("Upload failed. Check console for details.");
      }
    });
  </script>
</body>
</html>
